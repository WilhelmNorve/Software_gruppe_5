<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <title>Direkte avganger â€“ mock rute 630</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="page page-departures">
    <header>
        <div class="header-main">
            <h1>Direkte avganger â€“ mock rute 630</h1>
            <p class="muted">
                Skriv inn <b>fra</b>- og <b>til</b>-stopp. Du fÃ¥r forslag mens du skriver
                (f.eks. Â«haldenÂ», Â«fredrikstadÂ», Â«mossÂ»). Stavefeil som Â«hÃ¦ldenÂ» tolkes automatisk.
                Helt uforstÃ¥elige navn gir en forklarende beskjed slik som i konsoll-appen.
            </p>
        </div>


        <div>
            <div class="lang-switch">
                <button type="button" class="lang-btn" id="langBtn" title="SprÃ¥k">
                    ðŸ‡³ðŸ‡´
                </button>
                <div class="lang-menu" id="langMenu" aria-label="SprÃ¥kvalg">
                    <div class="lang-flag" title="Norsk">ðŸ‡³ðŸ‡´</div>
                    <div class="lang-flag" title="Engelsk">ðŸ‡¬ðŸ‡§</div>
                </div>
            </div>

            <button type="button"
                    class="secondary small back-login-btn"
                    id="backToLoginBtn">
                Til innlogging
            </button>
        </div>
    </header>

    <div class="layout">

        <div class="main-column">
            <form id="form" autocomplete="off">
                <div class="inputs">
                    <div class="field">
                        <label for="fromInput">Fra</label>
                        <input id="fromInput" type="text" placeholder="Startstopp" inputmode="search"
                               aria-autocomplete="list" aria-haspopup="listbox" />
                        <div id="acFrom" class="ac" role="listbox" hidden></div>
                    </div>
                    <div class="field">
                        <label for="toInput">Til</label>
                        <input id="toInput" type="text" placeholder="Sluttstopp" inputmode="search"
                               aria-autocomplete="list" aria-haspopup="listbox" />
                        <div id="acTo" class="ac" role="listbox" hidden></div>
                    </div>
                </div>
                <div class="actions">
                    <button type="button" class="secondary" id="useLocationBtn">
                        Min posisjon som fra-stopp
                    </button>
                    <button type="submit">Hent direkte avganger</button>
                    <button type="button" class="secondary ml-auto" id="showSavedBtn">
                        Lagrede ruter
                    </button>
                </div>
                <div id="msg" class="info" aria-live="polite"></div>
            </form>

            <section id="result" class="panel" hidden>
                <h2 id="stopTitle"></h2>
                <div id="list" class="grid"></div>
            </section>
        </div>

        <!-- HÃ˜YRE KOLONNE: lagrede ruter -->
        <aside class="saved-column">
            <section id="savedPanel" class="panel" hidden>
                <h2>Lagrede ruter</h2>
                <div id="savedList" class="grid"></div>
            </section>
        </aside>
    </div>
</div>

<script>
    const form = document.getElementById('form');
    const fromInput = document.getElementById('fromInput');
    const toInput = document.getElementById('toInput');
    const acFrom = document.getElementById('acFrom');
    const acTo = document.getElementById('acTo');
    const msg = document.getElementById('msg');
    const result = document.getElementById('result');
    const stopTitle = document.getElementById('stopTitle');
    const list = document.getElementById('list');
    const useLocationBtn = document.getElementById('useLocationBtn');
    const the_showSavedBtn = document.getElementById('showSavedBtn');
    const savedPanel = document.getElementById('savedPanel');
    const savedList = document.getElementById('savedList');
    const langBtn = document.getElementById('langBtn');
    const langMenu = document.getElementById('langMenu');
    const backToLoginBtn = document.getElementById('backToLoginBtn');

    let currentTrips = [];
    let currentFromStop = null;
    let currentToStop = null;

    const STORAGE_KEY = 'mock630_saved_routes';
    let savedRoutes = [];

    fromInput.dataset.stopId = '';
    toInput.dataset.stopId = '';

    loadSavedRoutes();
    renderSavedRoutes();

    attachAutocomplete(fromInput, acFrom, pickFrom, "START-stopp");
    attachAutocomplete(toInput, acTo, pickTo, "DESTINASJON-stopp");

    function pickFrom(item){
        fromInput.value = item.name;
        fromInput.dataset.stopId = item.id;
    }
    function pickTo(item){
        toInput.value = item.name;
        toInput.dataset.stopId = item.id;
    }

    form.addEventListener('submit', onSubmit);

    the_showSavedBtn.addEventListener('click', () => {
        savedPanel.hidden = !savedPanel.hidden;
    });


    backToLoginBtn.addEventListener('click', () => {
        window.location.href = "index.html";
    });

    langBtn.addEventListener('click', () => {
        langMenu.classList.toggle('open');
    });
    document.addEventListener('click', (e) => {
        if (!langMenu.contains(e.target) && e.target !== langBtn) {
            langMenu.classList.remove('open');
        }
    });

    // --------- "Din posisjon" knapp (geo) ---------
    useLocationBtn.addEventListener('click', async () => {
        msg.className = 'info';
        msg.textContent = 'Henter posisjon â€¦';

        if (!('geolocation' in navigator)) {
            msg.className = 'err';
            msg.textContent = 'Geolokasjon stÃ¸ttes ikke i denne nettleseren.';
            return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            try {
                const url = `/api/mock/nearestStop?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!resp.ok) {
                    const txt = await resp.text().catch(()=> '');
                    msg.className = 'err';
                    msg.textContent = `Fant ikke nÃ¦rmeste stopp (${resp.status}${txt ? ' â€“ ' + txt : ''})`;
                    return;
                }

                const data = await resp.json();
                if (!data || !data.id || !data.name) {
                    msg.className = 'err';
                    msg.textContent = 'Svar fra server manglet id/navn pÃ¥ nÃ¦rmeste stopp.';
                    return;
                }

                fromInput.value = data.name;
                fromInput.dataset.stopId = data.id;

                msg.className = 'ok';
                msg.textContent = `Fant nÃ¦rmeste stopp: ${data.name}`;
            } catch (err) {
                console.error(err);
                msg.className = 'err';
                msg.textContent = 'Kunne ikke hente nÃ¦rmeste stopp.';
            }
        }, (err) => {
            console.warn('Geolocation error', err);
            msg.className = 'err';
            if (err.code === err.PERMISSION_DENIED) {
                msg.textContent = 'Tillat bruk av posisjon for Ã¥ bruke denne funksjonen.';
            } else {
                msg.textContent = 'Klarte ikke Ã¥ hente posisjon.';
            }
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 30000
        });
    });

    async function onSubmit(e){
        e.preventDefault();
        msg.className = 'info';
        result.hidden = true;
        list.innerHTML = '';

        const fromId = (fromInput.dataset.stopId || '').trim();
        const toId   = (toInput.dataset.stopId || '').trim();

        if(!fromId || !toId){
            msg.className = 'err';
            msg.textContent = 'Velg bÃ¥de fra- og til-stopp fra forslagene (eller bruk posisjon for fra-stopp).';
            return;
        }

        try {
            msg.textContent = 'Henter avganger mellom stoppene â€¦';

            const url = `/api/mock/trips?fromId=${encodeURIComponent(fromId)}&toId=${encodeURIComponent(toId)}`;
            const resp = await fetch(url, {
                method:'GET',
                headers:{ 'Accept':'application/json' }
            });

            if (!resp.ok) {
                const txt = await resp.text().catch(()=> '');
                msg.className = 'err';
                msg.textContent = `Feil fra server: ${resp.status}${txt ? ' ('+txt+')' : ''}`;
                return;
            }

            const data = await resp.json();
            const usedFrom = data.from || {};
            const usedTo   = data.to   || {};
            const trips    = Array.isArray(data.trips) ? data.trips : [];

            currentTrips = trips;
            currentFromStop = usedFrom;
            currentToStop = usedTo;

            if (trips.length === 0) {
                msg.className = 'info';
                msg.textContent = 'Fant ingen direkte turer mellom disse stoppene i mock-rutetabellen.';
                result.hidden = false;
                stopTitle.textContent = `${usedFrom.name || fromInput.value} â†’ ${usedTo.name || toInput.value}`;
                return;
            }

            list.innerHTML = '';
            trips.forEach((t, idx) => {
                const row = document.createElement('div');

                const delay = typeof t.delayMinutes === 'number' ? t.delayMinutes : 0;
                const isCancelled = delay === 30;

                const plannedDep = t.departureTime || 'â€”';
                const plannedArr = t.arrivalTime || 'â€”';
                const newDep = t.newDeparture || plannedDep;
                const newArr = t.newArrival || plannedArr;

                let statusText, statusClass;
                if (delay === 0) {
                    statusText = 'I rute';
                    statusClass = 'status-on-time';
                } else if (isCancelled) {
                    statusText = 'KANSELLERT (30 min forsinkelse)';
                    statusClass = 'status-cancelled';
                } else {
                    statusText = `Forsinket +${delay} min`;
                    statusClass = 'status-delayed';
                }

                row.className = 'dep-row' + (isCancelled ? ' cancelled' : '');

                const line = t.line || '';
                const dir  = t.direction || '';
                const dur  = (t.durationMinutes != null ? `${t.durationMinutes} min` : 'ukjent tid');
                const stopsBefore = (t.stopsBeforeDest != null ? `${t.stopsBeforeDest} stopp fÃ¸r dest.` : '');

                const timeHtml = (delay > 0 && !isCancelled)
                    ? `<span>${escapeHtml(newDep)}</span>
                       <span class="muted-small">â†’ ${escapeHtml(newArr)}</span>
                       <span class="muted-small">Planlagt ${escapeHtml(plannedDep)} â†’ ${escapeHtml(plannedArr)}</span>
                       <span class="muted-small">${escapeHtml(dur)}</span>`
                    : `<span>${escapeHtml(newDep)}</span>
                       <span class="muted-small">â†’ ${escapeHtml(newArr)}</span>
                       <span class="muted-small">${escapeHtml(dur)}</span>`;

                row.innerHTML = `
          <div class="code">${escapeHtml(line)}</div>
          <div>
            <div><strong>${idx + 1}.</strong> mot ${escapeHtml(dir)}</div>
            <div class="muted-small">${escapeHtml(stopsBefore)}</div>
            <div class="status-badge ${statusClass}">${escapeHtml(statusText)}</div>
          </div>
          <div class="time">
            ${timeHtml}
          </div>
        `;

                row.addEventListener('click', () => {
                    showTripDetails(idx);
                });

                list.appendChild(row);
            });

            stopTitle.textContent = `${usedFrom.name || fromInput.value} â†’ ${usedTo.name || toInput.value} (${trips.length} avganger i mock-data)`;
            result.hidden = false;
            msg.textContent = '';

        } catch (err) {
            console.error(err);
            msg.className = 'err';
            msg.textContent = 'Kunne ikke hente avganger (nettverksfeil).';
        }
    }

    function findAlternativeOnTimeTrip(trips, chosenIndex) {
        if (!Array.isArray(trips) || trips.length === 0) return null;

        let bestIndex = -1;
        let bestDistance = Infinity;

        for (let i = 0; i < trips.length; i++) {
            if (i === chosenIndex) continue;
            const t = trips[i];
            const delay = typeof t.delayMinutes === 'number' ? t.delayMinutes : 0;
            if (delay !== 0) continue;

            const distance = Math.abs(i - chosenIndex);
            if (distance < bestDistance) {
                bestDistance = distance;
                bestIndex = i;
            } else if (distance === bestDistance) {
                if (bestIndex < chosenIndex && i > chosenIndex) {
                    bestIndex = i;
                }
            }
        }

        return bestIndex >= 0 ? bestIndex : null;
    }

    function makeRouteKey(trip, fromStop, toStop) {
        const sj = trip.serviceJourneyId || '';
        const the_dep = trip.departureTime || '';
        const fromId = fromStop && fromStop.id || '';
        const toId = toStop && toStop.id || '';
        return `${sj}__${fromId}__${toId}__${the_dep}`;
    }

    function findSavedIndexByKey(key) {
        return savedRoutes.findIndex(r => r.key === key);
    }

    function showTripDetails(index) {
        if (!currentTrips || !currentTrips[index]) return;

        const t = currentTrips[index];
        const fromStop = currentFromStop || {};
        const toStop   = currentToStop || {};

        const fromName = fromStop.name || '';
        const toName   = toStop.name   || '';
        const fromId   = fromStop.id   || '';
        const toId     = toStop.id     || '';

        const plannedDep = t.departureTime || 'â€”';
        const plannedArr = t.arrivalTime || 'â€”';
        const newDep = t.newDeparture || plannedDep;
        const newArr = t.newArrival || plannedArr;
        const dur  = (t.durationMinutes != null ? `${t.durationMinutes} min` : 'ukjent');
        const stopsBefore = (t.stopsBeforeDest != null ? t.stopsBeforeDest : 'ukjent');
        const delay = typeof t.delayMinutes === 'number' ? t.delayMinutes : 0;
        const isCancelled = delay === 30;

        let statusText;
        if (delay === 0) {
            statusText = 'I rute';
        } else if (isCancelled) {
            statusText = 'KANSELLERT (30 min forsinkelse)';
        } else {
            statusText = `Forsinket +${delay} min`;
        }

        const panelId = 'trip-details-panel';
        let panel = document.getElementById(panelId);
        if (!panel) {
            panel = document.createElement('div');
            panel.id = panelId;
            panel.className = 'panel';
            panel.style.marginTop = '1rem';
            result.insertAdjacentElement('afterend', panel);
        }

        if (isCancelled) {
            const altIndex = findAlternativeOnTimeTrip(currentTrips, index);
            if (altIndex != null) {
                const alt = currentTrips[altIndex];
                const altDelay = typeof alt.delayMinutes === 'number' ? alt.delayMinutes : 0;
                const altPlannedDep = alt.departureTime || 'â€”';
                const altPlannedArr = alt.arrivalTime || 'â€”';
                const altNewDep = alt.newDeparture || altPlannedDep;
                const altNewArr = alt.newArrival || altPlannedArr;
                const altDur  = (alt.durationMinutes != null ? `${alt.durationMinutes} min` : 'ukjent');
                const altStopsBefore = (alt.stopsBeforeDest != null ? alt.stopsBeforeDest : 'ukjent');

                panel.innerHTML = `
          <h3>Valgt avgang er kansellert</h3>

          <p><strong>Valgt avgang:</strong> KANSELLERT (30 min forsinkelse)</p>
          <table class="detail-table">
            <tr>
              <th>Planlagt</th>
              <th>Ny tid</th>
              <th>Forsinkelse</th>
            </tr>
            <tr>
              <td>Avgang: ${escapeHtml(plannedDep)}<br/>Ankomst: ${escapeHtml(plannedArr)}</td>
              <td>â€” (kansellert)</td>
              <td>30 min</td>
            </tr>
          </table>

          <hr class="detail-separator" />

          <h3>Anbefalt alternativ (i rute)</h3>
          <p><strong>Status:</strong> I rute</p>
          <table class="detail-table">
            <tr>
              <th>Planlagt</th>
              <th>Ny tid</th>
              <th>Forsinkelse</th>
            </tr>
            <tr>
              <td>Avgang: ${escapeHtml(altPlannedDep)}<br/>Ankomst: ${escapeHtml(altPlannedArr)}</td>
              <td>Avgang: ${escapeHtml(altNewDep)}<br/>Ankomst: ${escapeHtml(altNewArr)}</td>
              <td>${altDelay === 0 ? '0 min' : (altDelay + ' min')}</td>
            </tr>
          </table>

          <p><strong>Linje:</strong> ${escapeHtml(alt.line || '')} mot ${escapeHtml(alt.direction || '')}</p>
          <p><strong>PÃ¥stigning:</strong> ${escapeHtml(fromName)} (${escapeHtml(fromId)})</p>
          <p><strong>Avstigning:</strong> ${escapeHtml(toName)} (${escapeHtml(toId)})</p>
          <p><strong>Antall stopp fÃ¸r destinasjon:</strong> ${escapeHtml(String(altStopsBefore))}</p>
          <p><strong>Estimert reisetid:</strong> ${escapeHtml(altDur)}</p>

          <button type="button" id="saveRouteBtn" class="secondary small">
            Lagre anbefalt avgang
          </button>

          <p class="muted-small">Du kan ogsÃ¥ velge en annen avgang fra listen over.</p>
        `;

                setupSaveButton(alt, fromStop, toStop, 'Lagre anbefalt avgang');
            } else {
                panel.innerHTML = `
          <h3>Valgt avgang er kansellert</h3>
          <p><strong>Status:</strong> KANSELLERT (30 min forsinkelse)</p>
          <p>Vi fant ingen annen avgang som er i rute. GÃ¥ tilbake til listen og velg en annen avgang.</p>
        `;
            }

            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
        }

        panel.innerHTML = `
      <h3>Detaljer for valgt avgang</h3>

      <p><strong>Status:</strong> ${escapeHtml(statusText)}</p>

      <table class="detail-table">
        <tr>
          <th>Planlagt</th>
          <th>Ny tid</th>
          <th>Forsinkelse</th>
        </tr>
        <tr>
          <td>Avgang: ${escapeHtml(plannedDep)}<br/>Ankomst: ${escapeHtml(plannedArr)}</td>
          <td>Avgang: ${escapeHtml(newDep)}<br/>Ankomst: ${escapeHtml(newArr)}</td>
          <td>${delay === 0 ? '0 min' : (delay + ' min')}</td>
        </tr>
      </table>

      <p><strong>Linje:</strong> ${escapeHtml(t.line || '')} mot ${escapeHtml(t.direction || '')}</p>
      <p><strong>PÃ¥stigning:</strong> ${escapeHtml(fromName)} (${escapeHtml(fromId)})</p>
      <p><strong>Avstigning:</strong> ${escapeHtml(toName)} (${escapeHtml(toId)})</p>
      <p><strong>Antall stopp fÃ¸r destinasjon:</strong> ${escapeHtml(String(stopsBefore))}</p>
      <p><strong>Estimert reisetid:</strong> ${escapeHtml(dur)}</p>

      <button type="button" id="saveRouteBtn" class="secondary small">
        Lagre denne ruten
      </button>
    `;

        setupSaveButton(t, fromStop, toStop, 'Lagre denne ruten');
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function setupSaveButton(trip, fromStop, toStop, baseLabel) {
        const btn = document.getElementById('saveRouteBtn');
        if (!btn) return;
        const key = makeRouteKey(trip, fromStop, toStop);

        function refreshLabel() {
            const idx = findSavedIndexByKey(key);
            btn.textContent = idx === -1 ? baseLabel : 'Fjern fra lagrede';
        }

        btn.onclick = () => {
            const idx = findSavedIndexByKey(key);
            if (idx === -1) {
                const route = {
                    key,
                    fromName: fromStop.name || '',
                    fromId: fromStop.id || '',
                    toName: toStop.name || '',
                    toId: toStop.id || '',
                    line: trip.line || '',
                    direction: trip.direction || '',
                    plannedDep: trip.departureTime || '',
                    plannedArr: trip.arrivalTime || '',
                    newDep: trip.newDeparture || trip.departureTime || '',
                    newArr: trip.newArrival || trip.arrivalTime || '',
                    delayMinutes: typeof trip.delayMinutes === 'number' ? trip.delayMinutes : 0,
                    durationMinutes: trip.durationMinutes != null ? trip.durationMinutes : null,
                    createdAt: new Date().toISOString()
                };
                savedRoutes.push(route);
            } else {
                savedRoutes.splice(idx, 1);
            }
            saveSavedRoutes();
            renderSavedRoutes();
            refreshLabel();
        };

        refreshLabel();
    }

    function loadSavedRoutes() {
        try {
            const s = localStorage.getItem(STORAGE_KEY);
            savedRoutes = s ? JSON.parse(s) : [];
        } catch (e) {
            console.warn('Kunne ikke lese lagrede ruter fra localStorage', e);
            savedRoutes = [];
        }
    }

    function saveSavedRoutes() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedRoutes));
        } catch (e) {
            console.warn('Kunne ikke lagre ruter til localStorage', e);
        }
    }

    function renderSavedRoutes() {
        savedList.innerHTML = '';
        if (!savedRoutes.length) {
            savedList.innerHTML = '<p class="muted">Du har ingen lagrede ruter ennÃ¥. Velg en rute og trykk Â«Lagre denne rutenÂ».</p>';
            return;
        }

        savedRoutes
            .slice()
            .sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''))
            .forEach(route => {
                const card = document.createElement('div');
                card.className = 'saved-card';

                const delay = typeof route.delayMinutes === 'number' ? route.delayMinutes : 0;
                let statusText, statusClass;
                if (delay === 0) {
                    statusText = 'I rute';
                    statusClass = 'status-on-time';
                } else if (delay === 30) {
                    statusText = 'Kansellert';
                    statusClass = 'status-cancelled';
                } else {
                    statusText = `Forsinket +${delay} min`;
                    statusClass = 'status-delayed';
                }

                const title = document.createElement('div');
                title.className = 'saved-title';
                title.textContent = `${route.fromName || 'Ukjent'} â†’ ${route.toName || 'Ukjent'}`;

                const meta = document.createElement('div');
                meta.className = 'saved-meta';
                const time = document.createElement('span');
                time.className = 'saved-time';
                time.textContent = route.newDep || route.plannedDep || '';
                const badge = document.createElement('span');
                badge.className = `status-badge ${statusClass}`;
                badge.textContent = statusText;
                meta.appendChild(time);
                meta.appendChild(badge);

                const actions = document.createElement('div');
                actions.className = 'saved-actions';
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'secondary small';
                removeBtn.textContent = 'Fjern';
                removeBtn.addEventListener('click', () => {
                    const idx = savedRoutes.findIndex(r => r.key === route.key);
                    if (idx !== -1) {
                        savedRoutes.splice(idx, 1);
                        saveSavedRoutes();
                        renderSavedRoutes();
                    }
                });
                actions.appendChild(removeBtn);

                card.appendChild(title);
                card.appendChild(meta);
                card.appendChild(actions);
                savedList.appendChild(card);
            });
    }

    function attachAutocomplete(inputEl, panelEl, onPick, roleLabel){
        let items = [];
        let highlighted = -1;
        const debounced = debounce(handleInput, 200);

        inputEl.addEventListener('input', () => {
            inputEl.dataset.stopId = '';
            debounced();
        });

        inputEl.addEventListener('focus', () => {
            if (panelEl.children.length) panelEl.hidden = false;
        });

        document.addEventListener('click', (e) => {
            if (!panelEl.contains(e.target) && e.target !== inputEl) panelEl.hidden = true;
        });

        inputEl.addEventListener('keydown', (e) => {
            const max = items.length - 1;
            if (panelEl.hidden && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) panelEl.hidden = false;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlighted = Math.min(max, highlighted + 1);
                updateHighlight();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlighted = Math.max(0, highlighted - 1);
                updateHighlight();
            } else if (e.key === 'Enter') {
                if (!panelEl.hidden && highlighted >= 0) {
                    e.preventDefault();
                    pick(items[highlighted]);
                }
            } else if (e.key === 'Escape') {
                panelEl.hidden = true;
            }
        });

        async function handleInput(){
            const q = (inputEl.value || '').trim();
            if (!q || q.length < 2) {
                panelEl.hidden = true;
                panelEl.innerHTML = '';
                items = [];
                return;
            }
            try {
                const url = `/api/mock/stops?q=${encodeURIComponent(q)}`;
                const r = await fetch(url, {
                    headers: { 'Accept': 'application/json' }
                });

                if (r.status === 404) {
                    msg.className = 'info';
                    msg.textContent =
                        `Jeg forsto ikke hvor du mente som ${roleLabel}. ` +
                        `Rute 630 gÃ¥r mellom Halden, Fredrikstad-omrÃ¥det og Moss. ` +
                        `PrÃ¸v for eksempel Ã¥ sÃ¸ke pÃ¥ Â«HaldenÂ», Â«FredrikstadÂ», Â«MossÂ» ` +
                        `eller et konkret holdeplasnavn langs denne strekningen.`;
                    panelEl.hidden = true;
                    panelEl.innerHTML = '';
                    items = [];
                    return;
                }

                if (!r.ok) {
                    throw new Error(await r.text().catch(()=>`Feil ${r.status}`));
                }

                const data = await r.json();
                items = normalizeStops(data);
                render(items);
            } catch (err){
                console.error('Stops search failed', err);
                items = [];
                panelEl.hidden = true;
                panelEl.innerHTML = '';
            }
        }

        function render(list){
            if (!Array.isArray(list) || list.length === 0) {
                panelEl.hidden = true;
                panelEl.innerHTML = '';
                return;
            }
            highlighted = -1;
            panelEl.hidden = false;
            const ul = document.createElement('ul');
            list.forEach((it, i) => {
                const li = document.createElement('li');
                li.role = 'option';
                li.id = `${inputEl.id}-opt-${i}`;
                li.innerHTML = `
          <div class="title">${escapeHtml(it.name)}</div>
          <div class="sub">${escapeHtml(it.id)}</div>
        `;
                li.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    pick(it);
                });
                ul.appendChild(li);
            });
            panelEl.innerHTML = '';
            panelEl.appendChild(ul);
            inputEl.setAttribute('aria-expanded', 'true');
        }

        function updateHighlight(){
            const lis = panelEl.querySelectorAll('li');
            lis.forEach((li, idx) =>
                li.setAttribute('aria-selected', String(idx === highlighted))
            );
            if (highlighted >= 0 && lis[highlighted]) {
                lis[highlighted].scrollIntoView({ block: 'nearest' });
            }
        }

        function pick(item){
            onPick(item);
            panelEl.hidden = true;
            inputEl.setAttribute('aria-expanded', 'false');
        }
    }

    function normalizeStops(raw){
        if (!Array.isArray(raw)) return [];
        return raw
            .map(x => ({
                id: x.id || '',
                name: x.name || ''
            }))
            .filter(x => x.id && x.name);
    }

    function debounce(fn, ms){
        let t;
        return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
        };
    }

    function escapeHtml(s){
        return String(s)
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'",'&#39;');
    }
</script>
</body>
</html>



<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <title>Innlogging</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="page">
    <!-- LOGIN-KORT -->
    <div class="card" id="loginCard">
        <h1>Velkommen Vennligst<br>Logg Inn üöç</h1>

        <form id="loginForm" method="post" action="/login" autocomplete="on" novalidate>
            <label for="username">
                Brukernavn
                <input id="username" name="username" required autocomplete="username" />
            </label>

            <label for="password">
                Passord
                <input id="password" name="password" type="password" required autocomplete="current-password" />
            </label>

            <button type="submit">Logg inn</button>

            <!-- Slett konto-knapp under login -->
            <button type="button" id="deleteBtn">Slett konto</button>

            <p id="msg" class="info" aria-live="polite"></p>
            <p class="help">Ved vellykket innlogging sendes du videre til avganger.</p>
        </form>
    </div>

    <!-- REGISTRER-KORT (SKJULT I STARTEN) -->
    <div class="card hidden" id="registerCard">
        <h1>Registrer Ny Bruker üöç</h1>

        <form id="registerForm" method="post" action="/register" autocomplete="on" novalidate>
            <label for="regUsername">
                Brukernavn
                <input id="regUsername" name="username" required autocomplete="username" />
            </label>

            <label for="regPassword">
                Passord
                <input id="regPassword" name="password" type="password" required autocomplete="new-password" />
            </label>

            <label for="regPassword2">
                Gjenta passord
                <input id="regPassword2" name="password2" type="password" required autocomplete="new-password" />
            </label>

            <button type="submit">Opprett bruker</button>
            <p id="regMsg" class="info" aria-live="polite"></p>
            <p class="help">Etter vellykket registrering kan du logge inn med brukeren din.</p>
        </form>
    </div>

    <!-- BUNNTEKST / BYTTE MELLOM LOGIN OG REGISTRERING -->
    <p class="bottom-text" id="loginFooter">
        Har Ikke Bruker?
        <button type="button" id="showRegister" class="link-button">Registrer Deg</button>
    </p>

    <p class="bottom-text hidden" id="registerFooter">
        Har allerede bruker?
        <button type="button" id="showLogin" class="link-button">Logg inn</button>
    </p>
</div>

<script>
    (function () {
        // Elementer
        const loginCard      = document.getElementById("loginCard");
        const registerCard   = document.getElementById("registerCard");
        const loginFooter    = document.getElementById("loginFooter");
        const registerFooter = document.getElementById("registerFooter");

        const showRegisterBtn = document.getElementById("showRegister");
        const showLoginBtn    = document.getElementById("showLogin");

        const formLogin  = document.getElementById("loginForm");
        const formReg    = document.getElementById("registerForm");
        const msg        = document.getElementById("msg");
        const regMsg     = document.getElementById("regMsg");
        const loginBtn   = formLogin.querySelector("button[type=submit]");
        const deleteBtn  = document.getElementById("deleteBtn");
        const regBtn     = formReg.querySelector("button[type=submit]");

        // Vis/skjul kort
        function showLoginCard() {
            loginCard.classList.remove("hidden");
            loginFooter.classList.remove("hidden");
            registerCard.classList.add("hidden");
            registerFooter.classList.add("hidden");
            msg.textContent = "";
            regMsg.textContent = "";
        }

        function showRegisterCard() {
            loginCard.classList.add("hidden");
            loginFooter.classList.add("hidden");
            registerCard.classList.remove("hidden");
            registerFooter.classList.remove("hidden");
            msg.textContent = "";
            regMsg.textContent = "";
        }

        showRegisterBtn.addEventListener("click", showRegisterCard);
        showLoginBtn.addEventListener("click", showLoginCard);

        // LOGIN
        formLogin.addEventListener("submit", async (e) => {
            e.preventDefault();

            msg.className = "info";
            msg.textContent = "Logger inn‚Ä¶";
            loginBtn.disabled = true;
            deleteBtn.disabled = true;

            try {
                const fd = new FormData(formLogin);
                fd.set("username", (fd.get("username") || "").toString().trim());
                fd.set("password", (fd.get("password") || "").toString().trim());

                const body = new URLSearchParams(fd);

                const resp = await fetch(formLogin.action, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    credentials: "include",
                    redirect: "follow",
                    body
                });

                if (resp.ok) {
                    // G√• til avganger-side
                    location.href = "departures2.html";
                    return;
                }

                if (resp.status === 401) {
                    msg.className = "err";
                    msg.textContent = "Feil brukernavn eller passord ‚ùå";
                } else {
                    msg.className = "err";
                    msg.textContent = "Serverfeil. Pr√∏v igjen senere.";
                }
            } catch (err) {
                msg.className = "err";
                msg.textContent = "Kunne ikke kontakte serveren.";
            } finally {
                loginBtn.disabled = false;
                deleteBtn.disabled = false;
            }
        });

        // REGISTRERING
        formReg.addEventListener("submit", async (e) => {
            e.preventDefault();

            regMsg.className = "info";
            regMsg.textContent = "Oppretter bruker‚Ä¶";
            regBtn.disabled = true;

            try {
                const fd = new FormData(formReg);
                const u  = (fd.get("username") || "").toString().trim();
                const p1 = (fd.get("password") || "").toString();
                const p2 = (fd.get("password2") || "").toString();

                if (!u || !p1 || !p2) {
                    regMsg.className = "err";
                    regMsg.textContent = "Alle felt m√• fylles ut.";
                    regBtn.disabled = false;
                    return;
                }
                if (p1 !== p2) {
                    regMsg.className = "err";
                    regMsg.textContent = "Passordene er ikke like.";
                    regBtn.disabled = false;
                    return;
                }

                const body = new URLSearchParams();
                body.set("username", u);
                body.set("password", p1);

                const resp = await fetch(formReg.action, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    credentials: "include",
                    body
                });

                if (resp.ok) {
                    regMsg.className = "info";
                    regMsg.textContent = "Bruker opprettet! Du kan n√• logge inn.";
                    setTimeout(showLoginCard, 1500);
                    return;
                }

                if (resp.status === 409) {
                    regMsg.className = "err";
                    regMsg.textContent = "Brukernavn er allerede i bruk.";
                } else {
                    regMsg.className = "err";
                    regMsg.textContent = "Kunne ikke opprette bruker.";
                }
            } catch (err) {
                regMsg.className = "err";
                regMsg.textContent = "Kunne ikke kontakte serveren.";
            } finally {
                regBtn.disabled = false;
            }
        });

        // SLETT KONTO ‚Äì send til egen sletteside
        deleteBtn.addEventListener("click", () => {
            const username = document.getElementById("username").value.trim();

            if (!username) {
                msg.className = "err";
                msg.textContent = "Skriv inn brukernavn f√∏rst for √• slette.";
                return;
            }

            const url = "delete.html?username=" + encodeURIComponent(username);
            window.location.href = url;
        });
    })();
</script>
</body>
</html>




